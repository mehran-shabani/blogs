# ??? ?????? ??? ????? ???????? ?????

## ???? ???

??? ??? ?????? ??? ????? ?? ?? ????? ??? ??????.

## ?? ???????? ??????

### 1. ???? ????? (Presentation Layer)
**????????:** Next.js 15 + React 18 + TypeScript

- **App Router:** ??????? ?? App Directory ???? Next.js
- **Server Components:** ???? ?????????? ??????
- **Client Components:** ???? ??????? ??????
- **RTL Support:** ???????? ???? ?? ??????????
- **Dark Mode:** ?? Context API ? Tailwind
- **Responsive Design:** ????? ?????????

#### ???????????? ????:
```
SearchBar: ????? ??????? + ???????
ResultCard: ????? ???? + ?????
ThemeToggle: ????? ?? ????/????
AdminPanel: ?????? ???????
```

### 2. ???? API (API Layer)
**????????:** FastAPI + Pydantic

#### Endpoints:

**POST /api/search**
- ?????: query, use_web_search, top_k
- ?????: answer, sources, search_results
- ??????: Query ? Embedding ? Search ? RAG ? Response

**POST /api/ingest-url**
- ?????: URL
- ?????: success, message, chunks_count
- ??????: Scrape ? Normalize ? Chunk ? Embed ? Store

**GET/POST /api/config**
- ?????? ??????? OpenAI

**GET /api/health**
- Health Check

### 3. ???? ???? ???????? (Business Logic Layer)

#### RAG Engine
**????:** `backend/core/rag_engine.py`

Pipeline ???????:
```
1. ?????????? ???? (?? Hazm)
   ?
2. ????? Embedding
   ?
3. ???????? ?????? ?? Vector Store
   ?
4. ??? ????? < threshold:
   - ??????? ?? ?? ?? Firecrawl
   - Ingestion ?????? ????
   - ???????? ????
   ?
5. ????? Context ?? ?????
   ?
6. ????? ?? OpenAI ?? RAG Prompt
   ?
7. ????????? ???? + ?????
```

#### OpenAI Client
**????:** `backend/core/openai_client.py`

????????:
- ???????? ?? Custom Base URL
- Dynamic API Key
- Chat Completion
- Embeddings
- RAG Prompt Engineering

#### Firecrawl Client
**????:** `backend/core/firecrawl_client.py`

?????????:
- Scrape ?? URL
- Crawl ??? ????
- ??????? Markdown
- Web Search (???? ?????)

### 4. ???? ???? (Data Layer)

#### Vector Store (Qdrant)
**????:** `backend/db/vector_store.py`

```python
Collection: persian_documents
Vectors: 768-dimensional (multilingual-mpnet)
Distance: Cosine Similarity
Storage: In-memory (MVP) / Persistent (Production)
```

??????:
- `add_documents()`: ?????? Embeddings
- `search()`: ???????? ??????
- `delete_collection()`: ????????

#### Database Models (SQLAlchemy)
**????:** `backend/db/models.py`

**Document:**
- url, title, content, metadata
- timestamps

**DocumentChunk:**
- document_id, chunk_text, chunk_index
- embedding_vector (fallback)

**SearchHistory:**
- query, response, sources
- search_type, timestamp

### 5. ???? ?????? ???? (NLP Layer)

#### Text Normalization
**????????:** Hazm

??????:
- ??? ?????????? ?????
- ?????????? ?????
- Tokenization

#### Text Chunking
????????:
- Sliding Window
- Size: 500 tokens
- Overlap: 50 tokens
- ??? ????

#### Embedding Model
**??? ???????:**
```
sentence-transformers/paraphrase-multilingual-mpnet-base-v2
Dimension: 768
Languages: 50+ including Farsi
```

**??????????:**
- LaBSE (Google)
- HooshvareLab/bert-fa-base-uncased

## ?? ????? ???? (Data Flow)

### Scenario 1: ???????? ??????

```mermaid
User Input
    ?
Frontend (Next.js)
    ?
POST /api/search
    ?
RAG Engine
    ?? Normalize Query
    ?? Generate Embedding
    ?? Search Vector Store
    ?   ?
    ?   Found Results
    ?? Build Context
    ?? Call OpenAI
    ?? Return Response
    ?
Frontend Display
```

### Scenario 2: ??????? + Web

```mermaid
User Input + Web Search Enabled
    ?
Frontend (Next.js)
    ?
POST /api/search (use_web_search=true)
    ?
RAG Engine
    ?? Search Vector Store
    ?   ?
    ?   Insufficient Results
    ?? Firecrawl Search
    ?? Scrape URLs
    ?? Chunk & Embed
    ?? Add to Vector Store
    ?? Search Again
    ?? Build Context
    ?? Call OpenAI
    ?? Return Response
```

### Scenario 3: ?????? URL

```mermaid
Admin Panel
    ?
POST /api/ingest-url
    ?
Firecrawl Client
    ?? Scrape URL
    ?? Extract Content
    ?
RAG Engine
    ?? Normalize Text
    ?? Chunk Text
    ?? Generate Embeddings
    ?? Store in Qdrant
    ?? Return Success
```

## ?? ?????

### Authentication (Future)
- JWT Tokens
- Role-based Access
- Rate Limiting

### Data Protection
- API Key Masking
- Environment Variables
- HTTPS Only (Production)

### Input Validation
- Pydantic Models
- URL Validation
- Query Sanitization

## ? ??????????

### Frontend
- Server-Side Rendering (SSR)
- Static Site Generation (SSG) where possible
- Image Optimization
- Code Splitting
- Lazy Loading

### Backend
- Async/Await Patterns
- Connection Pooling
- Caching (Redis - Future)
- Background Tasks (Celery - Future)

### Database
- Index Optimization
- Vector Compression
- Batch Operations

## ?? ?????????? (Future)

### Metrics
- Request Latency
- Error Rates
- Token Usage
- Search Quality

### Logging
- Structured Logging
- Log Levels
- Request Tracing

### Alerting
- Error Alerts
- Performance Degradation
- Quota Limits

## ?? ???

### Backend
```bash
pytest backend/tests/
```

### Frontend
```bash
npm run test
```

### Integration
```bash
pytest backend/tests/integration/
```

## ?? Deployment

### Docker Support (Future)

```dockerfile
# Backend
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "main.py"]

# Frontend
FROM node:18-alpine
WORKDIR /app
COPY package*.json .
RUN npm install
COPY . .
RUN npm run build
CMD ["npm", "start"]
```

### Production Considerations

1. **Environment Variables**
   - Separate configs for dev/staging/prod
   - Secret management

2. **Scaling**
   - Horizontal scaling with load balancer
   - Separate Vector Store instance
   - CDN for static assets

3. **Database**
   - PostgreSQL for structured data
   - Qdrant Cloud for vectors
   - Backup strategy

4. **Monitoring**
   - Application Performance Monitoring (APM)
   - Error Tracking (Sentry)
   - Analytics

## ?? References

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Next.js Documentation](https://nextjs.org/docs)
- [Qdrant Documentation](https://qdrant.tech/documentation/)
- [OpenAI API Reference](https://platform.openai.com/docs/api-reference)
- [Sentence Transformers](https://www.sbert.net/)
- [Hazm Documentation](https://github.com/roshan-research/hazm)
