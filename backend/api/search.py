"""
API Endpoints ???? ???????
"""
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, HttpUrl
from typing import Optional, List, Dict, Any
from core.rag_engine import rag_engine
from api.config import settings, update_openai_config
from core.openai_client import openai_client

router = APIRouter()


class SearchRequest(BaseModel):
    """??? ??????? ???????"""
    query: str
    use_web_search: bool = False
    top_k: int = 5


class SearchResponse(BaseModel):
    """??? ???? ???????"""
    answer: str
    sources: List[str]
    query: str
    search_results: List[Dict[str, Any]]


class IngestURLRequest(BaseModel):
    """??? ??????? ?????? URL"""
    url: HttpUrl


class ConfigRequest(BaseModel):
    """??? ??????? ???????"""
    api_key: str
    base_url: str


class ConfigResponse(BaseModel):
    """??? ???? ???????"""
    api_key: str
    base_url: str
    model: str


@router.post("/search", response_model=SearchResponse)
async def search(request: SearchRequest):
    """
    ???????? ?????? ?? RAG
    
    - **query**: ???? ????? ?????
    - **use_web_search**: ??????? ?? ???????? ?? (???????: False)
    - **top_k**: ????? ????? (???????: 5)
    """
    try:
        result = rag_engine.process_query(
            query=request.query,
            use_web_search=request.use_web_search,
            top_k=request.top_k
        )
        return SearchResponse(**result)
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"??? ?? ?????? ???????: {str(e)}")


@router.post("/ingest-url")
async def ingest_url(request: IngestURLRequest):
    """
    ?????? URL ?? ?????? ????
    
    - **url**: ???? ???? ?? ???? ????? ? ??????
    """
    try:
        result = rag_engine.ingest_url(str(request.url))
        return result
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"??? ?? ?????? URL: {str(e)}")


@router.get("/config", response_model=ConfigResponse)
async def get_config():
    """
    ?????? ??????? ???? OpenAI
    """
    # ????? ??? 4 ??????? ??? API Key
    masked_key = settings.openai_api_key[:10] + "..." if len(settings.openai_api_key) > 10 else "***"
    
    return ConfigResponse(
        api_key=masked_key,
        base_url=settings.openai_base_url,
        model=settings.openai_model
    )


@router.post("/config")
async def update_config(request: ConfigRequest):
    """
    ??????????? ??????? OpenAI
    
    - **api_key**: ???? API ????
    - **base_url**: ???? Base URL ????
    """
    try:
        # ??????????? ???????
        update_openai_config(request.api_key, request.base_url)
        openai_client.update_config(request.api_key, request.base_url)
        
        return {
            "success": True,
            "message": "? ??????? ?? ?????? ??????????? ??"
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"??? ?? ??????????? ???????: {str(e)}")


@router.get("/health")
async def health_check():
    """????? ????? API"""
    return {
        "status": "healthy",
        "message": "?? API ?? ??? ???? ???"
    }
