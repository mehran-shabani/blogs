"""
?????? OpenAI ?? ???????? ?? ??????? ??????
"""
from openai import OpenAI
from typing import List, Dict, Any
from api.config import settings


class OpenAIClient:
    """?????? OpenAI ?? ?????? ????? API Key ? Base URL"""
    
    def __init__(self):
        self.client = None
        self._initialize_client()
    
    def _initialize_client(self):
        """???????? ????? ?????? OpenAI"""
        self.client = OpenAI(
            api_key=settings.openai_api_key,
            base_url=settings.openai_base_url
        )
    
    def update_config(self, api_key: str, base_url: str):
        """??????????? ???????? OpenAI"""
        settings.openai_api_key = api_key
        settings.openai_base_url = base_url
        self._initialize_client()
    
    def get_embedding(self, text: str, model: str = "text-embedding-ada-002") -> List[float]:
        """?????? embedding ???? ???"""
        try:
            response = self.client.embeddings.create(
                model=model,
                input=text
            )
            return response.data[0].embedding
        except Exception as e:
            print(f"??? ?? ?????? embedding: {e}")
            return []
    
    def chat_completion(
        self,
        messages: List[Dict[str, str]],
        temperature: float = 0.7,
        max_tokens: int = 2000
    ) -> str:
        """????? ??????? chat completion"""
        try:
            response = self.client.chat.completions.create(
                model=settings.openai_model,
                messages=messages,
                temperature=temperature,
                max_tokens=max_tokens
            )
            return response.choices[0].message.content
        except Exception as e:
            print(f"??? ?? chat completion: {e}")
            return f"???????? ????? ?? ???: {str(e)}"
    
    def generate_rag_response(
        self,
        query: str,
        context: str,
        sources: List[str]
    ) -> Dict[str, Any]:
        """????? ???? RAG ?? ?????? ?????"""
        
        # ?????? RAG ?????
        system_prompt = """??? ?? ?????? ?????? ?????????? ????? ?? ????? ????? ?? ?????? ??????? ?? ???? ??????? ????? ???? ????.

?????? ???:
1. ??? ?? ??????? ????? ?? ??? ????? ??????? ????
2. ??? ????? ?? ??? ????? ????? ??????? ?????? ?? ?????????
3. ???????? ????? ???? ? ???? ??? ????? ????
4. ?? ???? ????? ???? ? ???? ??????? ????
5. ?? ???? ?????? ?? ????? ????? ????

?????? ????:
- ???? ????: ?? ???????? ???? ? ????
- ??????? ??????: ?????? ????? ?? ???? ????
- ?????: ???? ????? ???????????"""

        user_prompt = f"""????: {query}

??? ?????:
{context}

????? ?????:
{chr(10).join(f'- {source}' for source in sources)}

????? ?? ???? ???? ????."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        answer = self.chat_completion(messages, temperature=0.3)
        
        return {
            "answer": answer,
            "sources": sources,
            "query": query
        }


# ????? ??????
openai_client = OpenAIClient()
